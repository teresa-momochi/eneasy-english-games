<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="google" content="notranslate">
  <title>Make a Sentence</title>

  <style>
    /* =========================
       0) 固定舞台：1280 x 720
       ========================= */
    body{
      margin:0;
      background:#333;
      height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      font-family: Arial, "Microsoft JhengHei", sans-serif;
    }
    #game-stage{
      position:relative;
      width:1280px;
      height:720px;
      background:url('images/bg.png') no-repeat center;
      background-size:cover;
      overflow:hidden;
    }

    /* =========================
       1) Header / Toggle / Music
       ========================= */
    .header-title{
      position:absolute;
      top:40px;
      left:50%;
      transform:translateX(-50%);
      background:#ffeb3b;
      padding:10px 60px;
      border-radius:30px;
      font-size:56px;
      font-weight:800;
      z-index:10;
      user-select:none;
    }
    #mode-toggle{
      position:absolute;
      top:20px;
      right:20px;
      width:100px;
      cursor:pointer;
      z-index:100;
      user-select:none;
    }
    #btn-bgmusic{
      position:absolute;
      top:20px;
      right:140px;
      width:60px;
      cursor:pointer;
      z-index:100;
      user-select:none;
    }

    /* =========================
       2) 題目圖片
       ========================= */
    #img-question{
      position:absolute;
      top:230px;
      left:60px;
      width:280px;
      height:280px;
      object-fit:contain;
      background:#fff;
      border:8px solid #fff;
      border-radius:20px;
      user-select:none;
    }

    /* =========================
       3) 答案框 + finger
       ========================= */
    .answer-container{
      position:absolute;
      top:350px;
      left:380px;
      display:flex;
      gap:15px;
    }
    .frame-box{
      position:relative;
      width:280px;
      text-align:center;
      user-select:none;
    }
    .word-display{
      position:absolute;
      top:5px;
      left:5px;
      width:270px;
      height:85px;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none; 
    }
    .word-display img{
      max-width:90%;
      max-height:80%;
      user-select:none;
      -webkit-user-drag:none;
    }
    .finger-btn{
      margin-top:15px;
      cursor:pointer;
      width:100px;
      user-select:none;
      -webkit-user-drag:none;
      transition: opacity 0.3s;
    }

    .finger-disabled{
      opacity:0.35;
      filter:grayscale(1);
      cursor:not-allowed;
    }

    /* =========================
       4) 下方控制按鈕
       ========================= */
    .controls{
      position:absolute;
      bottom:30px;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:60px;
      z-index:50;
      user-select:none;
    }
    .icon-btn{
      cursor:pointer;
      height:100px;
      -webkit-user-drag:none;
    }
    .icon-btn.disabled{
      filter: grayscale(1);
      opacity: 0.45;
      cursor: not-allowed;
      pointer-events: none;
    }
    .icon-btn.bright{
      filter: drop-shadow(0 0 20px #ffff00);
    }

    /* =========================
       5) 錯誤怪獸層
       ========================= */
    #wrong-overlay{
      position:absolute;
      top:0; left:0;
      width:100%; height:100%;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:200;
    }
    #wrong-overlay img{
      max-height:85%;
      user-select:none;
      -webkit-user-drag:none;
    }

    #step-hint{
      position:absolute;
      top:170px;
      left:60px;
      padding:6px 12px;
      border-radius:12px;
      background:rgba(0,0,0,0.55);
      color:#fff;
      font-size:18px;
      z-index:15;
      user-select:none;
    }
  </style>
</head>

<body>
  <div id="game-stage">
    <div class="header-title">Make a Sentence</div>

    <img src="icons/bgmusic.png" id="btn-bgmusic" alt="bgmusic" />
    <img src="icons/off.png" id="mode-toggle" alt="mode" />
    <div id="step-hint">Step: 1 (Frame1)</div>

    <img src="images/cat.png" id="img-question" alt="question" />

    <div class="answer-container">
      <div class="frame-box">
        <img src="images/answerframe/answerframe1.png" style="width:100%" alt="frame1">
        <div id="slot-1" class="word-display"></div>
        <img src="icons/finger1.png" id="finger-1" class="finger-btn" alt="finger1">
      </div>

      <div class="frame-box">
        <img src="images/answerframe/answerframe2.png" style="width:100%" alt="frame2">
        <div id="slot-2" class="word-display"></div>
        <img src="icons/finger2.png" id="finger-2" class="finger-btn" alt="finger2">
      </div>

      <div class="frame-box">
        <img src="images/answerframe/answerframe3.png" style="width:100%" alt="frame3">
        <div id="slot-3" class="word-display"></div>
        <img src="icons/finger3.png" id="finger-3" class="finger-btn" alt="finger3">
      </div>
    </div>

    <div class="controls">
      <img src="icons/next.png" id="btn-next" class="icon-btn disabled" alt="next">
      <img src="icons/enter.png" id="btn-enter" class="icon-btn" alt="enter">
      <img src="icons/trash.png" id="btn-trash" class="icon-btn" alt="trash">
    </div>

    <div id="wrong-overlay">
      <img src="images/wrong.png" alt="wrong">
    </div>
  </div>

  <audio id="snd-bg" src="sounds/bgmusic.mp3" loop></audio>
  <audio id="snd-wrong" src="sounds/wrong.mp3"></audio>
  <audio id="snd-correct" src="sounds/correct.mp3"></audio>

  <script>
    /* =========================================================
       題庫與路徑設定
       ========================================================= */
    const questions = [
      { img: "cat.png", ans: [["it","is","a_cat"]] },
      { img: "dog.png", ans: [["it","is","a_dog"]] },
      { img: "boy.png", ans: [["i","am","a_boy"], ["i","am","nick"]] },
      { img: "dad.png", ans: [["he","is","dad"], ["he","is","nick"]] },
      { img: "mom.png", ans: [["she","is","mom"], ["she","is","judy"]] },
      { img: "you.png", ans: [["you","are","nick"], ["you","are","a_boy"]] },
      { img: "she.png", ans: [["she","is","judy"]] }
    ];

    const bank = {
      1: ["i","you","he","she","it"],
      2: ["am","are","is"],
      3: ["a_boy","a_cat","a_dog","nick","judy","dad","mom"]
    };

    const pathMap = {
      1: "images/answerframe/options.frame1/",
      2: "images/answerframe/options.frame2/",
      3: "images/answerframe/options.frame3/"
    };

    /* =========================================================
       遊戲狀態
       ========================================================= */
    let qIdx = 0;
    let isTeacherMode = false;
    let isLocked = false;
    let step = 1;
    let passed = false;
    let selections = [null,null,null];

    const elQuestion = document.getElementById("img-question");
    const elWrongOverlay = document.getElementById("wrong-overlay");
    const elStepHint = document.getElementById("step-hint");
    const elNext = document.getElementById("btn-next");
    const elEnter = document.getElementById("btn-enter");
    const elTrash = document.getElementById("btn-trash");
    const elFinger1 = document.getElementById("finger-1");
    const elFinger2 = document.getElementById("finger-2");
    const elFinger3 = document.getElementById("finger-3");
    const sndBg = document.getElementById("snd-bg");
    const sndWrong = document.getElementById("snd-wrong");
    const sndCorrect = document.getElementById("snd-correct");
    const elModeToggle = document.getElementById("mode-toggle");
    const elBgmBtn = document.getElementById("btn-bgmusic");

    /* =========================================================
       功能函數
       ========================================================= */
    function setSlotImage(frameNo, token){
      const slot = document.getElementById(`slot-${frameNo}`);
      slot.innerHTML = token ? `<img src="${pathMap[frameNo]}word_${token}.png" alt="${token}">` : "";
    }

    function clearSlots(){
      selections = [null,null,null];
      for(let i=1;i<=3;i++) setSlotImage(i, null);
    }

    function updateStepHint(){
      const map = {1:"Step: 1 (Frame1)", 2:"Step: 2 (Frame2)", 3:"Step: 3 (Frame3)"};
      elStepHint.textContent = map[step] || "Step";
    }

    function updateFingerState(){
      const fingers = [
        {el: elFinger1, no: 1},
        {el: elFinger2, no: 2},
        {el: elFinger3, no: 3}
      ];
      fingers.forEach(({el, no})=>{
        const enabled = isTeacherMode ? true : (no === step);
        if(!enabled || isLocked){
          el.classList.add("finger-disabled");
        }else{
          el.classList.remove("finger-disabled");
        }
      });
    }

    function updateNextState(){
      if(isTeacherMode || passed){
        elNext.classList.remove("disabled");
        elNext.classList.add("bright");
      }else{
        elNext.classList.add("disabled");
        elNext.classList.remove("bright");
      }
    }

    function updateUI(){
      updateStepHint();
      updateFingerState();
      updateNextState();
    }

    function loadQuestion(){
      isLocked = false;
      passed = false;
      step = 1;
      clearSlots();
      elWrongOverlay.style.display = "none";
      elQuestion.src = `images/${questions[qIdx].img}`;
      updateUI();
    }

    function rotate(frameNo){
      if(isLocked) return;
      if(!isTeacherMode && frameNo !== step) return;
      const list = bank[frameNo];
      const idxNow = selections[frameNo - 1];
      const nextIdx = (idxNow === null) ? 0 : (idxNow + 1) % list.length;
      selections[frameNo - 1] = nextIdx;
      setSlotImage(frameNo, list[nextIdx]);
    }

    /* 核心修正：錯誤怪獸 1.5秒消失但維持鎖定 */
    function checkAnswer(){
      if(isLocked || isTeacherMode) return;

      const user = selections.map((s, i)=> s !== null ? bank[i+1][s] : null);
      if(step === 1 && !user[0]) return;
      if(step === 2 && (!user[0] || !user[1])) return;
      if(step === 3 && (!user[0] || !user[1] || !user[2])) return;

      const ansList = questions[qIdx].ans;
      let ok = false;

      if(step === 1){
        ok = ansList.some(a => a[0] === user[0]);
        if(ok) step = 2;
      }else if(step === 2){
        ok = ansList.some(a => a[0] === user[0] && a[1] === user[1]);
        if(ok) step = 3;
      }else if(step === 3){
        ok = ansList.some(a => a[0] === user[0] && a[1] === user[1] && a[2] === user[2]);
        if(ok){
          passed = true;
          sndCorrect.currentTime = 0;
          sndCorrect.play().catch(()=>{});
        }
      }

      if(!ok){
        isLocked = true;
        elWrongOverlay.style.display = "flex";
        sndWrong.currentTime = 0;
        sndWrong.play().catch(()=>{});

        // 1.5秒後怪獸自動退場，但不解鎖 isLocked
        setTimeout(() => {
          elWrongOverlay.style.display = "none";
          updateUI();
        }, 1500);
      }
      updateUI();
    }

    function clearAll(){
      isLocked = false;
      passed = false;
      step = 1;
      clearSlots();
      elWrongOverlay.style.display = "none";
      updateUI();
    }

    function toggleMode(){
      isTeacherMode = !isTeacherMode;
      elModeToggle.src = isTeacherMode ? "icons/on.png" : "icons/off.png";
      updateUI();
    }

    function toggleMusic(){
      sndBg.paused ? sndBg.play().catch(()=>{}) : sndBg.pause();
    }

    function goNext(){
      if(!(isTeacherMode || passed)) return;
      if(qIdx < questions.length - 1){
        qIdx++;
        loadQuestion();
      }else{
        alert("恭喜完成所有題目！");
        qIdx = 0;
        loadQuestion();
      }
    }

    elFinger1.addEventListener("click", ()=> rotate(1));
    elFinger2.addEventListener("click", ()=> rotate(2));
    elFinger3.addEventListener("click", ()=> rotate(3));
    elEnter.addEventListener("click", checkAnswer);
    elTrash.addEventListener("click", clearAll);
    elNext.addEventListener("click", goNext);
    elModeToggle.addEventListener("click", toggleMode);
    elBgmBtn.addEventListener("click", toggleMusic);

    window.addEventListener("load", loadQuestion);
  </script>
</body>
</html>
