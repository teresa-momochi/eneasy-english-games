<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Matching Game - Word & Picture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="google" content="notranslate" />

  <style>
    :root{
      --bg:#f5f5f5;
      --card:#ffffff;
      --line:#ccc;
      --back:#ffd54f;
      --accent:#1565c0;
    }
    *{ box-sizing:border-box; }

    body{
      font-family: Arial, "Microsoft JhengHei", sans-serif;
      background: var(--bg);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      min-height:100vh;
      margin:0;
      padding:20px;
    }

    h1{
      margin: 10px 0 5px;
      font-size: 24px;
      text-align:center;
    }
    p.subtitle{
      margin: 0 0 10px;
      font-size: 14px;
      text-align:center;
      max-width: 860px;
      line-height: 1.4;
    }

    #hud{
      width: min(980px, 100%);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin: 8px 0 10px;
    }
    .pill{
      background:#fff;
      border:1px solid #e3e3e3;
      border-radius:999px;
      padding:6px 12px;
      font-size:14px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    #controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    button{
      padding: 8px 14px;
      border-radius: 8px;
      border: none;
      background: #42a5f5;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    button:hover{ filter: brightness(1.06); }

    #message{
      margin-top: 6px;
      font-size: 14px;
      text-align: center;
      min-height: 18px;
    }

    #game-board{
      width: min(980px, 100%);
      display:grid;
      grid-template-columns: repeat(5, minmax(70px, 1fr));
      gap: 10px;
      justify-content:center;
      margin-top: 10px;
    }

    @media (max-width: 520px){
      #game-board{ grid-template-columns: repeat(4, minmax(70px, 1fr)); }
    }

    .card{
      width: 100%;
      padding-top: 100%;
      position: relative;
      perspective: 800px;
      cursor: pointer;
    }

    .card-inner{
      position:absolute;
      inset:0;
      transition: transform 0.4s;
      transform-style: preserve-3d;
    }

    .card.flipped .card-inner,
    .card.matched .card-inner{
      transform: rotateY(180deg);
    }

    .card-front,
    .card-back{
      position:absolute;
      inset:0;
      backface-visibility:hidden;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      user-select:none;
      background: var(--card);
      border: 2px solid var(--line);
      overflow:hidden;
    }

    .card-back{
      background: var(--back);
    }
    .card-back img{
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      display:block;
    }

    .card-front{
      transform: rotateY(180deg);
      padding: 6px;
      text-align:center;
    }

    .word-card{
      color: var(--accent);
      font-weight: 700;
      font-size: 22px;
      letter-spacing: 0.5px;
    }

    .card-front img{
      max-width: 92%;
      max-height: 92%;
      object-fit: contain;
      display:block;
    }

    .dim{
      opacity: 0.55;
      pointer-events:none;
    }
  </style>
</head>

<body>
  <h1>Matching Game</h1>
  <p class="subtitle">
    è¦å‰‡ï¼šç¿»ç‰Œå°±æœƒå”¸å–®å­—ï¼ˆç¬¬ä¸€å¼µä¹Ÿå”¸ã€ç¬¬äºŒå¼µä¹Ÿå”¸ï¼‰ã€‚æ–‡å­—ï¼‹åœ–ç‰‡é…å°æˆåŠŸæœƒç•™ä¸‹ä¾†ã€‚
    å…¨éƒ¨ 10 å°å®Œæˆï¼šåœæ­¢è¨ˆæ™‚ â†’ æ’­æ”¾ä¸€æ¬¡ sounds/harry.mp3 â†’ è‡ªå‹•æ´—ç‰Œé€²ä¸‹ä¸€å±€ï¼ˆè¨ˆæ™‚æ­¸é›¶ï¼‰ã€‚
  </p>

  <div id="hud">
    <div class="pill">â±ï¸ Time: <span id="time">00:00</span></div>
    <div class="pill">âœ… Matched: <span id="matched">0</span>/10</div>
    <div id="controls">
      <button id="reset-btn">é‡æ–°æ´—ç‰Œ</button>
    </div>
  </div>

  <div id="message"></div>
  <div id="game-board"></div>

  <script>
    /********************
     * ä½ åªè¦æ”¹é€™è£¡ï¼š10 å€‹å–®å­—ï¼ˆå¿…é ˆå°æ‡‰ images/<word>.pngï¼‰
     ********************/
    const words = ["kid", "keg", "kite", "lamp", "leg", "lab", "bell", "wall", "doll", "clock"];

    /********************
     * å›ºå®šæª”æ¡ˆè·¯å¾‘ï¼ˆä¾ä½ çš„è³‡æ–™å¤¾ï¼‰
     ********************/
    const BACK_IMAGE = "images/smile.png";
    const WIN_SOUND = "sounds/harry.mp3";

    const board = document.getElementById("game-board");
    const resetBtn = document.getElementById("reset-btn");
    const messageEl = document.getElementById("message");
    const timeEl = document.getElementById("time");
    const matchedEl = document.getElementById("matched");

    // å…¨é€šé—œéŸ³æ•ˆï¼šåªåœ¨æ•´å±€å®Œæˆæ™‚æ’­æ”¾ä¸€æ¬¡
    const winSound = new Audio(WIN_SOUND);
    winSound.preload = "auto";

    let cardsData = [];
    let firstCard = null;
    let secondCard = null;
    let lockBoard = false;

    // è¨ˆæ™‚
    let timerId = null;
    let startMs = 0;
    let elapsedMs = 0;

    // matched è¨ˆæ•¸ï¼ˆä»¥ã€Œå°ã€è¨ˆï¼‰
    let matchedPairs = 0;

    // æ´—ç‰Œ
    function shuffle(array){
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    // å»ºç«‹ 20 å¼µè³‡æ–™ï¼š10 word + 10 image
    function createCardsData(){
      const temp = [];
      words.forEach(word => {
        temp.push({ key: word, type: "word" });
        temp.push({ key: word, type: "image" });
      });
      cardsData = shuffle(temp);
    }

    function buildBoard(){
      board.innerHTML = "";

      cardsData.forEach((data, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.index = String(index);
        card.dataset.key = data.key;
        card.dataset.type = data.type;

        const inner = document.createElement("div");
        inner.className = "card-inner";

        // èƒŒé¢ï¼šsmile.png
        const back = document.createElement("div");
        back.className = "card-back";
        const backImg = document.createElement("img");
        backImg.src = BACK_IMAGE;
        backImg.alt = "back";
        backImg.onerror = () => {
          back.textContent = "ğŸ˜Š";
          back.style.fontSize = "34px";
          back.style.fontWeight = "700";
        };
        back.appendChild(backImg);

        // æ­£é¢ï¼šæ–‡å­— or åœ–ç‰‡
        const front = document.createElement("div");
        front.className = "card-front";

        if (data.type === "word") {
          front.classList.add("word-card");
          front.textContent = data.key;
        } else {
          const img = document.createElement("img");
          img.src = "images/" + data.key + ".png";
          img.alt = data.key;
          img.onerror = () => {
            // åœ–æŠ“ä¸åˆ°è‡³å°‘é¡¯ç¤ºå­—ï¼Œä¸è¦ç©ºç™½
            front.innerHTML = "";
            front.classList.add("word-card");
            front.textContent = data.key;
          };
          front.appendChild(img);
        }

        inner.appendChild(back);
        inner.appendChild(front);
        card.appendChild(inner);

        card.addEventListener("click", onCardClick);
        board.appendChild(card);
      });
    }

    /********************
     * æœ—è®€ï¼šç¿»ç‰Œå°±å”¸ï¼ˆAï¼šç¬¬ä¸€å¼µä¹Ÿå”¸ã€ç¬¬äºŒå¼µä¹Ÿå”¸ï¼‰
     ********************/
    function speakWord(word){
      if (!("speechSynthesis" in window)) return;
      try{
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(word);
        utter.lang = "en-US";
        utter.rate = 0.9;
        window.speechSynthesis.speak(utter);
      }catch(e){
        // å¿½ç•¥
      }
    }

    /********************
     * è¨ˆæ™‚
     ********************/
    function formatTime(ms){
      const totalSec = Math.floor(ms / 1000);
      const mm = String(Math.floor(totalSec / 60)).padStart(2, "0");
      const ss = String(totalSec % 60).padStart(2, "0");
      return `${mm}:${ss}`;
    }

    function startTimer(){
      stopTimer();
      startMs = Date.now();
      elapsedMs = 0;
      timeEl.textContent = "00:00";
      timerId = setInterval(() => {
        elapsedMs = Date.now() - startMs;
        timeEl.textContent = formatTime(elapsedMs);
      }, 250);
    }

    function stopTimer(){
      if (timerId){
        clearInterval(timerId);
        timerId = null;
      }
    }

    function setMessage(text){
      messageEl.textContent = text || "";
    }

    function updateMatchedHud(){
      matchedEl.textContent = String(matchedPairs);
    }

    /********************
     * é»ç‰Œ
     ********************/
    function onCardClick(e){
      if (lockBoard) return;

      const card = e.currentTarget;
      if (card.classList.contains("flipped")) return;
      if (card.classList.contains("matched")) return;

      // ç¿»é–‹
      card.classList.add("flipped");

      // âœ… Aï¼šæ¯ç¿»ä¸€å¼µéƒ½å”¸
      speakWord(card.dataset.key);

      // ç¬¬ä¸€å¼µ
      if (!firstCard){
        firstCard = card;
        return;
      }

      // ç¬¬äºŒå¼µ
      if (card === firstCard) return;

      secondCard = card;
      lockBoard = true;
      checkForMatch();
    }

    function checkForMatch(){
      const sameWord = firstCard.dataset.key === secondCard.dataset.key;
      const differentType = firstCard.dataset.type !== secondCard.dataset.type;

      if (sameWord && differentType){
        // âœ… æˆåŠŸ
        firstCard.classList.add("matched");
        secondCard.classList.add("matched");
        matchedPairs += 1;
        updateMatchedHud();
        setMessage("ğŸ‘ Good! æ‰¾åˆ°ä¸€å°ï¼");
        resetSelection();

        // âœ… å…¨é€šé—œ
        if (matchedPairs === words.length){
          onRoundComplete();
        }
      } else {
        // âŒ å¤±æ•—ï¼Œç¿»å›å»
        setTimeout(() => {
          firstCard.classList.remove("flipped");
          secondCard.classList.remove("flipped");
          resetSelection();
        }, 800);
      }
    }

    function resetSelection(){
      firstCard = null;
      secondCard = null;
      lockBoard = false;
    }

    /********************
     * å…¨é€šé—œï¼šåœæ­¢è¨ˆæ™‚ â†’ æ’­ä¸€æ¬¡ MP3 â†’ è‡ªå‹•æ´—ç‰Œé€²ä¸‹ä¸€å±€
     ********************/
    function onRoundComplete(){
      stopTimer();
      lockBoard = true; // å…ˆé–ä½ä¸è¦å†é»
      setMessage(`ğŸ‰ All matched! Time: ${timeEl.textContent}  æ’­æ”¾éŸ³æ•ˆå¾Œé€²ä¸‹ä¸€å±€â€¦`);

      // ä¿è­·ï¼šé¿å…ä¸Šä¸€è¼ª onended å½±éŸ¿
      winSound.onended = null;

      // å¾é ­æ’­ä¸€æ¬¡
      try { winSound.currentTime = 0; } catch(e){}

      const goNextRound = () => {
        // é¿å…é‡è¤‡è§¸ç™¼
        winSound.onended = null;
        resetGame();
      };

      // å˜—è©¦æ’­æ”¾ï¼ˆé€šå¸¸å› ç‚ºç©å®¶æœ‰äº’å‹•ï¼ŒæœƒæˆåŠŸï¼‰
      winSound.play()
        .then(() => {
          // æ’­å®Œç«‹åˆ»ä¸‹ä¸€å±€
          winSound.onended = goNextRound;

          // å‚™æ´ï¼šæœ‰äº›ç€è¦½å™¨ä¸ä¸€å®šæœƒè§¸ç™¼ onendedï¼ˆæ¥µå°‘ï¼‰ï¼Œçµ¦å€‹ä¸Šé™ä¿è­·
          setTimeout(goNextRound, 5000);
        })
        .catch(() => {
          // è‹¥è¢«ç€è¦½å™¨æ“‹ï¼Œç›´æ¥ä¸‹ä¸€å±€ï¼ˆä¸è¦å¡ä½ï¼‰
          goNextRound();
        });
    }

    /********************
     * é‡ç½®ä¸€å±€ï¼šæ´—ç‰Œ + é‡å»º + è¨ˆæ™‚æ­¸é›¶é–‹å§‹
     ********************/
    function resetGame(){
      // å–æ¶ˆå¯èƒ½æ­£åœ¨å¿µçš„å­—
      if ("speechSynthesis" in window) {
        try { window.speechSynthesis.cancel(); } catch(e){}
      }

      stopTimer();
      setMessage("");
      lockBoard = false;
      firstCard = null;
      secondCard = null;
      matchedPairs = 0;
      updateMatchedHud();

      createCardsData();
      buildBoard();
      startTimer();
    }

    resetBtn.addEventListener("click", resetGame);

    // å•Ÿå‹•ç¬¬ä¸€å±€
    resetGame();
  </script>
</body>
</html>
